var buildApp=angular.module("app_builds",["ngResource","editor.services","lang.services","builds.services","repository.services"]);buildApp.controller("ctrl_builds",["$scope","$http","componente_env","componente","plantillas","plantillas_comp","template","lang","directorioelemento","tree","dir_tmpl_tree","dir_item_tree","repotree","directorio","archivo","plantillaentidad","fileUpload","repository","entity_repo","entitydef","buildproject",function(e,t,o,r,n,l,d,i,a,s,c,_,u,m,f,g,p,y,b,E,h){function v(){$("#popBubble").hide("fast")}e.environment_selected=$("#key_module").val(),e.project_selected=$("#key_project").val(),e.node_selected,e.node_item_selected,console.log(e.environment_selected),e.components=[],e.itr_plantillas=0,e.treeModel=[],e.nodeComponente=[],e.direlemento_selected={id:null,nombre:null,id_padre:null,nombre_padre:null,tags:null,as_list:null},e.elementoentidad_selected={id:null,nombre:null,nombre_padre:null,tag:null},e.template_selected={id:null,nombre:null},e.repository_selected={data:null},e.entity_added={entity:null,scope:null},e.types_types=[],e.Conversions=[],e.EntityTags=[],e.entities_added=[],e.template_tags=[],e.entity_scope=[],e.GencoPlantillas,e.GencoComponentes,e.GencoDirectorios=new m,e.GencoArchivos=new f,e.GencoElementoEntidad=new g,e.repositories=[],e.langs=[],e.langs=i.query(),e.all_repository=y.query(),e.all_entities=[],e.GencoRepositorioEntidad,e.GencoEntidadDefinicion=new E,e.GencoEntidadFields=[],e.globalMessage="NA",e.ConfirmDeleteCallback=null,e.dataLang={repeatSelectLang:null,availableOptions:e.langs},e.asListModel={value:!0},typeError="ERROR",typeInfo="INFO",typeWarning="WARNING",$("#jstreeFolders").jstree({core:{check_callback:function(e,t,o,r,n){n&&(n.is_multi?n.origin.settings.dnd.always_copy=!0:n.origin.settings.dnd.always_copy=!1);var l;if(null==o||void 0===o.li_attr)return!1;console.log(o);var d=o.li_attr["data-renderas"];return void 0!==d&&(l="folder"===d,console.log(d),l&&"move_node"==e&&(l="file"===t.li_attr["data-renderas"]||"template"===t.li_attr["data-renderas"]),l)}},types:{file:{icon:"glyphicon glyphicon-file"},default:{icon:"glyphicon glyphicon-folder-open"}},crrm:{move:{always_copy:!0}},plugins:["contextmenu","sort","dnd","types","crrm"],contextmenu:{items:function(t){if(console.log(t.li_attr["data-renderas"]),"template"===t.li_attr["data-renderas"])return{Rename:{label:"Select Entities",action:function(t){console.log(t);var o=$.jstree.reference(t.reference).get_node(t.reference).li_attr["data-renderid"];null!=e.repository_selected.data&&void 0!=e.repository_selected.data?e.template_entities_load(o):e.infoBubble("Select Repository!","#dropdownRepo")}},Delete:{label:"Detach Template",action:function(t){console.log(t);var o=$.jstree.reference(t.reference).get_node(t.reference);console.log(o),e.showConfirmDelete("Do you really want to detach "+o.text+" Template?"),e.ConfirmDeleteCallback=function(){e.delete_directorioelemento(o.li_attr["data-renderiddirtemplate"],o)}}}};var o=$.jstree.defaults.contextmenu.items();return delete o.create.action,o.create.label="New",o.create.submenu={create_folder:{separator_after:!0,label:"Folder",action:function(t){var o=$.jstree.reference(t.reference).get_node(t.reference);e.node_selected=o,e.new_directorio(e.project_selected,o.id)}},create_file:{label:"File",action:function(t){var o=$.jstree.reference(t.reference).get_node(t.reference);e.node_selected=o,console.log(t),e.new_file(o.id)}}},"file"===t.li_attr["data-renderas"]&&delete o.create,o.rename={label:"Edit",action:function(t){console.log("rename");var o=$.jstree.reference(t.reference).get_node(t.reference);e.node_selected=o;var r=o.li_attr["data-renderid"];"folder"===o.li_attr["data-renderas"]?(e.load_directorio(o.id),$("#folder-edit-modal").modal("show")):(e.load_file(r),$("#file-edit-modal").modal("show"))}},o.remove={label:"Delete",action:function(t){console.log("delete");var o=$.jstree.reference(t.reference).get_node(t.reference);e.node_selected=o;var r=o.li_attr["data-renderid"];"folder"===o.li_attr["data-renderas"]?(e.showConfirmDelete("Do you really want to delete "+o.text+" Folder?"),e.ConfirmDeleteCallback=function(){e.delete_directorio(r,o)}):(e.showConfirmDelete("Do you really want to delete "+o.text+" File?"),e.ConfirmDeleteCallback=function(){e.delete_file(r,o)})}},delete o.ccp,o}}}).bind("copy_node.jstree",function(t,o){console.log(o.node),console.log(o.parent),$("#jstreeFolders").jstree(!0).select_node(o.node.id),e.new_directorioelemento(o.parent,o.node.li_attr["data-renderid"],null,o.node,null)}).bind("dblclick.jstree",function(t){var o=$(this).jstree(),r=o.get_node(t.target);if("template"==r.li_attr["data-renderas"])if(null!=e.repository_selected.data&&void 0!=e.repository_selected.data){o.get_path(r).join("/");var n=r.li_attr["data-renderiddirtemplate"];console.log(n);var l=o.get_node(r.parents[0]);console.log(l),console.log(l.li_attr["data-rendername"]+"/"+r.li_attr["data-rendername"]),e.direlemento_selected={id:n,nombre:r.li_attr["data-rendername"],nombre_padre:l.li_attr["data-rendername"],tags:r.li_attr["data-rendertags"],as_list:r.li_attr["data-renderaslist"]},1==e.direlemento_selected.as_list?e.asListModel.value=!0:e.asListModel.value=!1,console.log("data"),console.log(n),console.log(e.repository_selected.data.id_repositorio),e.getItemTree(n,e.repository_selected.data.id_repositorio)}else e.infoBubble("Select Repository!","#dropdownRepo")}).bind("move_node.jstree",function(t,o){console.log("SE movio un nodo hacer update ././././././../."),console.log(o.node.li_attr["data-renderid"]),console.log(o.parent),$("#jstreeFolders").jstree(!0).select_node(o.node.id),e.update_directorioelemento(o.node.li_attr["data-renderiddirtemplate"],o.parent)}),$("#jstreeBuilds").jstree({core:{check_callback:!0},plugins:["contextmenu","sort","dnd"],contextmenu:{items:function(t){return console.log(t.li_attr["data-renderas"]),"template"===t.li_attr["data-renderas"]?{Rename:{label:"Change Entity",action:function(t){var o=$.jstree.reference(t.reference).get_node(t.reference),r=o.li_attr["data-renderid"];e.elementoentidad_selected={id:r,nombre:o.li_attr["data-rendername"]},e.node_item_selected=o,angular.element($("#ctrl_builds")).scope().$apply(),$("#template-entities-modal").modal("show")}},Delete:{label:"Detach Entity",action:function(t){var o=$.jstree.reference(t.reference).get_node(t.reference);e.node_item_selected=o,e.showConfirmDelete("Do you really want to detach "+o.text+" Link?"),e.ConfirmDeleteCallback=function(){e.delete_elementoentidad(o.li_attr["data-renderid"],o)}}}}:{Rename:{label:"Change Entity",action:function(t){var o=$.jstree.reference(t.reference).get_node(t.reference),r=$("#jstreeBuilds").jstree(!0).get_node(""+o.parent),n=r.li_attr["data-renderid"];e.elementoentidad_selected={id:n,nombre_padre:r.li_attr["data-rendername"],tag:o.li_attr["data-renderid"]},e.node_item_selected=o,angular.element($("#ctrl_builds")).scope().$apply(),$("#template-entities-tag-modal").modal("show")}}}}}}).bind("dblclick.jstree",function(t){var o=$(this).jstree(),r=o.get_node(t.target);console.log(r.parent);var n=o.get_node(""+r.parent);console.log(n),n.parents.length>0?(e.elementoentidad_selected={id:n.li_attr["data-renderid"],nombre_padre:n.li_attr["data-rendername"],tag:r.li_attr["data-renderid"]},e.node_item_selected=r,angular.element($("#ctrl_builds")).scope().$apply(),$("#template-entities-tag-modal").modal("show")):(e.elementoentidad_selected={id:null,nombre:null,nombre_padre:null,tag:null},e.node_item_selected=r,angular.element($("#ctrl_builds")).scope().$apply(),$("#template-entities-modal").modal("show"))}),$("#jstree").jstree({core:{check_callback:function(e,t,o,r,n){var l;return null!=o&&void 0!==o.li_attr&&(console.log(e),"move_node"!=e&&"copy_node"!=e||(l=!1),l)}},crrm:{move:{always_copy:"multitree"}},plugins:["dnd","sort","crrm"]}),e.getCmpTree=function(){s.get({id:e.environment_selected},function(e){console.log("success"),$("#jstree").jstree(),$("#jstree").jstree(!0).settings.core.data=e.dirs,$("#jstree").jstree(!0).refresh()},function(t){e.showMessage(e.getDataError(t),typeError)})},e.getDirTree=function(){c.get({id:e.project_selected},function(e){console.log("success"),$("#jstreeFolders").jstree(),$("#jstreeFolders").jstree(!0).settings.core.data=e.dirs,$("#jstreeFolders").jstree(!0).refresh()},function(t){e.showMessage(e.getDataError(t),typeError)})},e.getItemTree=function(t,o){null!==t&&_.get({id_direlemento:t,id_repositorio:o},function(e){console.log("success"),$("#jstreeBuilds").jstree(),$("#jstreeBuilds").jstree(!0).settings.core.data=e.dirs,$("#jstreeBuilds").jstree(!0).refresh()},function(t){$("#jstreeBuilds").jstree(!0).settings.core.data={},$("#jstreeBuilds").jstree(!0).refresh(),e.showMessage(e.getDataError(t),typeError)})},e.tabs=[],e.current_template,e.new_directorioelemento=function(t,o,r,n,l){var d=new a;d.id_directorio=t,d.id_plantilla=o,d.id_archivo=r,e.save_directorioelemento(d,n,l)},e.save_directorioelemento=function(t,o,r){console.log("nodeeeeeee"),console.log(o),t.$save(function(t){console.log(t),null!=r&&"file"==r.li_attr["data-renderas"]?(e.addTreeNode(o,r,$("#jstreeFolders").jstree(!0)),$("#file-create-modal").modal("hide"),$("#file-edit-modal").modal("hide")):(o.li_attr["data-renderiddirtemplate"]=t.id_direlemento,console.log(o))},function(t){e.showMessage(e.getDataError(t),typeError),$("#jstreeFolders").jstree(!0).delete_node(o)})},e.delete_directorioelemento=function(t,o){a.delete({id:t},function(e){console.log("****************************************************"),console.log(o),$("#jstreeFolders").jstree(!0).delete_node(o)},function(t){e.showMessage(e.getDataError(t),typeError)})},e.update_directorioelemento_asList=function(){dirElemento=new a;var t=$("#chkAsList").button("loading");a.get({id:e.direlemento_selected.id},function(o){dirElemento=o,dirElemento.entidades_en_lista=e.asListModel.value?1:null,dirElemento.$update(function(e){t.button("reset")},function(o){e.showMessage(e.getDataError(o),typeError),t.button("reset")})},function(o){e.showMessage(e.getDataError(o),typeError),t.button("reset")})},e.update_directorioelemento=function(t,o){dirElemento=new a,a.get({id:t},function(t){dirElemento=t,dirElemento.id_directorio=o,dirElemento.$update(function(e){},function(t){e.showMessage(e.getDataError(t),typeError)})},function(t){e.showMessage(e.getDataError(t),typeError)})},e.new_directorio=function(t,o){e.GencoDirectorios=new m,e.GencoDirectorios.id_proyecto=t,e.GencoDirectorios.id_padre=o,$("#folder-create-modal").modal("show")},e.save_directorio=function(){e.GencoDirectorios.$save(function(t){console.log(t);var o={id:t.id_directorio,parent:t.id_padre,text:t.nombre,icon:"glyphicon glyphicon-folder-open",li_attr:{"data-renderas":"folder","data-renderid":t.id_directorio,"data-rendername":t.nombre}};console.log(e.node_selected),console.log(o),e.addTreeNode(e.node_selected,o,$("#jstreeFolders").jstree(!0)),$("#folder-create-modal").modal("hide")},function(t){e.showMessage(e.getDataError(t),typeError)})},e.delete_directorio=function(t,o){m.delete({id_directorio:t},function(e){console.log("****************************************************"),console.log(o),$("#jstreeFolders").jstree(!0).delete_node(o)},function(t){e.showMessage(e.getDataError(t),typeError)})},e.load_directorio=function(t){console.log(t);var o=m.get({id_directorio:t},function(t){e.GencoDirectorios=o},function(t){e.showMessage(e.getDataError(t),typeError)})},e.update_directorio=function(){console.log(e.GencoDirectorios),e.GencoDirectorios.$update(function(t){console.log(t),e.renameTreeNode(e.node_selected,t.nombre),$("#folder-edit-modal").modal("hide")},function(t){e.showMessage(e.getDataError(t),typeError)})},e.addTreeNode=function(e,t,o){console.log(o),o.create_node(e.id,t)},e.renameTreeNode=function(e,t){$("#jstreeFolders").jstree("set_text",e,t)},e.new_file=function(t){e.GencoArchivos=new f,$("#file-create-modal").modal("show")},e.save_file=function(){console.log("save file"),console.log(e.GencoArchivos);var t=e.myFile;console.log("file is "),console.dir(t);var o=new File([editor.getValue()],"foo.log");console.log(o),obj=e.node_selected,console.log("////////////////////////////"),console.log(obj.id),console.log(obj);var r=p.saveFileToUrl(o,e.GencoArchivos,obj,e.node_selected,e.new_directorioelemento);console.log("respuesta "+r)},e.update_file=function(){console.log("update file"),console.log(e.GencoArchivos);var t=e.myFile;console.log("file is "),console.dir(t);var o=new File([editor2.getValue()],"foo.log");console.log(o),console.log(e.node_selected),obj=e.node_selected;var r=p.updateFileToUrl(o,e.GencoArchivos,obj,e.node_selected,e.renameTreeNode);console.log("respuesta "+r),$("#file-edit-modal").modal("hide")},e.load_file=function(o){console.log("data passssss"),f.get({id:o},function(o){e.GencoArchivos=o,t.get(e.GencoArchivos.upload).success(function(e){editor2.setValue(e)}).error(function(e){console.log(error)})},function(t){e.showMessage(e.getDataError(t),typeError)})},e.delete_file=function(t,o){f.delete({id:t},function(e){console.log("****************************************************"),console.log(o),$("#jstreeFolders").jstree(!0).delete_node(o)},function(t){e.showMessage(e.getDataError(t),typeError)})},e.load_repository=function(){y.query(function(t){e.repositories=t},function(t){e.showMessage(e.getDataError(t),typeError)})},e.infoBubble=function(e,t){var o=$(t),r=o.offset();o.width();$("#popBubbleText").html(e),$("#popBubble").css({top:r.top-60,left:r.left-180,position:"absolute"}),$("#popBubble").show("fast",function(){setTimeout(function(){v()},3e3)})},e.change_repository=function(t){console.log(t.nombre),e.repository_selected.data=t,e.load_entities(t.id_repositorio),e.getItemTree(e.direlemento_selected.id,e.repository_selected.data.id_repositorio)},e.new_elemento_entidad=function(t,o){console.log(e.direlemento_selected.nombre),e.GencoElementoEntidad=new g,e.GencoElementoEntidad.id_direlemento=t,e.GencoElementoEntidad.id_entidad=o,e.GencoElementoEntidad.tags=e.direlemento_selected.tags,e.save_elemento_entidad()},e.save_elemento_entidad=function(){e.GencoElementoEntidad.$save(function(t){console.log(t);var o=e.direlemento_selected.nombre+'<sub style="color:#CCCCCC">@</sub><b>'+$("#cbxEntity option:selected").text(),r={id:t.id_elementoentidad,parent:"#",text:o,icon:"glyphicon glyphicon-folder-open",li_attr:{"data-renderas":"direlemento","data-renderid":t.id_elementoentidad,"data-rendername":e.direlemento_selected.nombre,"data-renderentity":t.id_entidad}};e.addTreeNode($("#jstreeBuilds").jstree(!0).get_node("#"),r,$("#jstreeBuilds").jstree(!0));var n={};if(null!=t.tags||void 0!=t.tags){console.log(""+t.tags);var l=JSON.parse(""+t.tags);console.log(l);for(var d in l)if(l.hasOwnProperty(d)){l[d];n={id:d+t.id_elementoentidad,parent:t.id_elementoentidad,text:d+'<sub style="color:#CCCCCC">@</sub><b></b>',icon:"glyphicon glyphicon-file",li_attr:{"data-renderas":"tagelemento","data-renderid":d,"data-rendername":d,"data-renderentity":-1}},e.addTreeNode($("#jstreeBuilds").jstree(!0).get_node(""+t.id_elementoentidad),n,$("#jstreeBuilds").jstree(!0))}}},function(t){e.showMessage(e.getDataError(t),typeError)})},e.update_elemento_entidad=function(t,o){node=e.node_item_selected;var r=node.li_attr["data-renderid"];console.log(node);for(var n,l={},d=0;d<node.children_d.length;d++)l[(n=$("#jstreeBuilds").jstree(!0).get_node(""+node.children_d[d])).li_attr["data-renderid"]]=parseInt(n.li_attr["data-renderentity"]);e.GencoElementoEntidad=new g,e.GencoElementoEntidad.id_direlemento=t,e.GencoElementoEntidad.id_entidad=o,e.GencoElementoEntidad.id_elementoentidad=r,e.GencoElementoEntidad.tags=JSON.stringify(l),e.GencoElementoEntidad.$update(function(t){var o=e.direlemento_selected.nombre+'<sub style="color:#CCCCCC">@</sub><b>'+$("#cbxEntity option:selected").text();e.renameTreeNode(e.node_item_selected,o),$("#template-entities-modal").modal("hide")},function(t){e.showMessage(e.getDataError(t),typeError)})},e.update_elemento_entidad_tag=function(t,o){nodeTag=e.node_item_selected;for(var r,n=e.elementoentidad_selected.id,l=$("#jstreeBuilds").jstree(!0).get_node(""+nodeTag.parent),d=l.li_attr["data-renderentity"],i={},a=0;a<l.children_d.length;a++)r=$("#jstreeBuilds").jstree(!0).get_node(""+l.children_d[a]),e.elementoentidad_selected.tag==r.li_attr["data-renderid"]?i[r.li_attr["data-renderid"]]=parseInt(o):i[r.li_attr["data-renderid"]]=parseInt(r.li_attr["data-renderentity"]);e.GencoElementoEntidad=new g,e.GencoElementoEntidad.id_direlemento=t,e.GencoElementoEntidad.id_entidad=d,e.GencoElementoEntidad.id_elementoentidad=n,e.GencoElementoEntidad.tags=JSON.stringify(i),e.GencoElementoEntidad.$update(function(t){var o=e.elementoentidad_selected.tag+'<sub style="color:#CCCCCC">@</sub><b>'+$("#cbxEntityTag option:selected").text();e.renameTreeNode(e.node_item_selected,o),$("#template-entities-tag-modal").modal("hide")},function(t){e.showMessage(e.getDataError(t),typeError)})},e.delete_elementoentidad=function(t,o){g.delete({id:t},function(e){$("#jstreeBuilds").jstree(!0).delete_node(o)},function(t){e.showMessage(e.getDataError(t),typeError)})},e.load_entities=function(t){e.types_types=b.query({id_repositorio:t},function(e){console.log(e)},function(t){e.showMessage(e.getDataError(t),typeError)})},e.showMessage=function(e,t){$("#imConfirm").html(e),$("#borderMessage").css("border-left-color","#eee"),t==typeError?$("#borderMessage").css("border-left-color","#d9534f"):t==typeInfo?$("#borderMessage").css("border-left-color","#5bc0de"):t==typeWarning&&$("#borderMessage").css("border-left-color","#f0ad4e"),$("#message-modal").modal("show")},e.showConfirmDelete=function(e){$("#tedmConfirm").html(e),$("#confirm-delete-modal").modal("show")},e.confirm_delete=function(){$("#confirm-delete-modal").modal("hide"),e.ConfirmDeleteCallback()},e.getDataError=function(e){if(null!=e.data.detail)return e.data.detail;if(null!=e.data){var t="";return e.data instanceof Array||e.data instanceof Object?angular.forEach(e.data,function(e,o){t+=o+" - "+e+"<br/>"}):t=e.data,t}},e.buildProject=function(){if(null!=e.repository_selected.data&&void 0!=e.repository_selected.data){var t=$("#btnBuildProject").button("loading");h.query({id_project:e.project_selected,id_repository:e.repository_selected.data.id_repositorio},function(o){t.button("reset"),e.showMessage("The project was build successfully",typeInfo)},function(o){t.button("reset"),e.showMessage(e.getDataError(o),typeError)})}else e.infoBubble("Select Repository!","#dropdownRepo")},function(){var e=document.getElementById("fileInput"),t=document.getElementById("fileDisplayArea");e.addEventListener("change",function(o){var r=e.files[0],n=/text.*/;if(r.type.match(n)){var l=new FileReader;l.onload=function(e){editor.setValue(l.result)},l.readAsText(r)}else t.innerText="File not supported!"})}(),e.load_repository(),e.getCmpTree(),e.getDirTree()}]),angular.module("app_builds").config(["$httpProvider",function(e){e.defaults.withCredentials=!0,e.defaults.xsrfCookieName="csrftoken",e.defaults.xsrfHeaderName="X-CSRFToken"}]),angular.module("app_builds").directive("fileModel",["$parse",function(e){return{restrict:"A",link:function(t,o,r){var n=e(r.fileModel).assign;o.bind("change",function(){t.$apply(function(){n(t,o[0].files[0])})})}}}]);